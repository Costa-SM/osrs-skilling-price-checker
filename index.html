<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OSRS Smithing Profit Tracker</title>
  <style>
    :root {
      --bg:       #0e0902;
      --panel:    #1b1308;
      --border:   #3e2e0e;
      --text:     #f0e6c8;
      --muted:    #8a7040;
      --gold:     #e8b820;
      --green:    #46a046;
      --red:      #c03232;
      --green-bg: #0a1e0a;
      --red-bg:   #1e0a0a;
      --hover:    #181008;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', 'Trebuchet MS', sans-serif;
      padding: 24px 20px;
      min-height: 100vh;
    }

    h1 { font-size: 1.7rem; color: var(--gold); margin-bottom: 4px; }
    .subtitle { color: var(--muted); font-size: 0.87rem; margin-bottom: 18px; }

    /* â”€â”€ Toolbar â”€â”€ */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }
    #status            { font-size: 0.85rem; color: var(--muted); }
    #status.loading    { color: var(--gold); }
    #status.error      { color: var(--red);  }
    #countdown         { font-size: 0.82rem; color: var(--muted); }
    #nature-price      { font-size: 0.85rem; color: var(--muted); }

    button {
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 5px 13px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.83rem;
    }
    button:hover { border-color: var(--gold); color: var(--gold); }

    /* â”€â”€ Tabs â”€â”€ */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0;
    }
    .tab {
      background: var(--panel);
      color: var(--muted);
      border: 1px solid var(--border);
      border-bottom: none;
      padding: 7px 20px;
      border-radius: 3px 3px 0 0;
      cursor: pointer;
      font-size: 0.88rem;
      margin-bottom: -1px;
    }
    .tab.active            { background: var(--bg); color: var(--gold); border-bottom: 1px solid var(--bg); z-index: 1; }
    .tab:hover:not(.active){ color: var(--text); }

    .tab-panel         { display: none; padding-top: 16px; }
    .tab-panel.active  { display: block; }

    /* â”€â”€ Anvil controls â”€â”€ */
    .controls {
      display: flex;
      align-items: center;
      gap: 18px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .ctrl-group { display: flex; align-items: center; gap: 6px; }
    .ctrl-label { font-size: 0.82rem; color: var(--muted); }

    .cbtn {
      background: var(--panel);
      color: var(--muted);
      border: 1px solid var(--border);
      padding: 3px 10px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.79rem;
    }
    .cbtn.active           { background: #2a1f0a; color: var(--gold); border-color: var(--gold); }
    .cbtn:hover:not(.active){ color: var(--text); }

    /* â”€â”€ Tables â”€â”€ */
    .scroll { overflow-x: auto; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
      min-width: 780px;
    }

    th {
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 8px 11px;
      text-align: left;
      color: var(--gold);
      white-space: nowrap;
      font-weight: 600;
    }

    td {
      border: 1px solid var(--border);
      padding: 7px 11px;
      vertical-align: middle;
    }

    tr:hover td { background: var(--hover); }

    .r { text-align: right; white-space: nowrap; }

    /* â”€â”€ Profit styling â”€â”€ */
    .pos { color: var(--green); font-weight: 600; }
    .neg { color: var(--red);   font-weight: 600; }
    .na  { color: var(--muted); }

    .badge {
      display: inline-block;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 1px 5px;
      border-radius: 3px;
      margin-left: 5px;
      letter-spacing: 0.4px;
      vertical-align: middle;
    }
    .bp { background: var(--green-bg); color: var(--green); border: 1px solid var(--green); }
    .bl { background: var(--red-bg);   color: var(--red);   border: 1px solid var(--red); }

    /* â”€â”€ Metal tier pills â”€â”€ */
    .pill {
      display: inline-block;
      font-size: 0.72rem;
      font-weight: 600;
      padding: 1px 8px;
      border-radius: 10px;
      white-space: nowrap;
    }
    .pill-Bronze  { background: #2a1800; color: #cd8040; border: 1px solid #6a3a10; }
    .pill-Iron    { background: #1a1a1a; color: #a0a0a0; border: 1px solid #505050; }
    .pill-Steel   { background: #161626; color: #9090c8; border: 1px solid #404070; }
    .pill-Mithril { background: #0a0a28; color: #5870ff; border: 1px solid #282870; }
    .pill-Adamant { background: #081808; color: #38b838; border: 1px solid #185818; }
    .pill-Rune    { background: #001828; color: #38b8d8; border: 1px solid #085888; }

    .sub-note  { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }
    .note-cell { color: var(--muted); font-size: 0.78rem; max-width: 200px; line-height: 1.4; }

    /* â”€â”€ Volume â”€â”€ */
    .vol-hi  { color: var(--green); }
    .vol-mid { color: var(--muted); }
    .vol-lo  { color: var(--red);   }

    /* â”€â”€ Smelting inputs â”€â”€ */
    .inputs    { line-height: 1.65; }
    .qty       { color: var(--gold); margin-right: 3px; }
    .each      { color: var(--muted); font-size: 0.78rem; }

    /* â”€â”€ Footer â”€â”€ */
    footer {
      margin-top: 22px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 12px 16px;
      font-size: 0.82rem;
      color: var(--muted);
      line-height: 1.65;
      max-width: 780px;
    }
    footer strong { color: var(--text); }
  </style>
</head>
<body>

<h1>&#9874; OSRS Smithing Profit Tracker</h1>
<p class="subtitle">Live Grand Exchange prices &mdash; F2P smithing, furnace vs. Superheat Item</p>

<div class="toolbar">
  <span id="status">Loading&hellip;</span>
  <button onclick="refresh()">&#8635; Refresh now</button>
  <span id="countdown"></span>
  <span id="nature-price"></span>
</div>

<div class="tabs">
  <button class="tab active" onclick="showTab('smelting', this)">ðŸ”¥ Smelting</button>
  <button class="tab"        onclick="showTab('anvil',    this)">&#9874; Anvil Smithing</button>
</div>

<!-- â”€â”€ Smelting tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="tab-smelting" class="tab-panel active">
  <div class="scroll">
    <table>
      <thead>
        <tr>
          <th>Bar</th>
          <th class="r">Lvl</th>
          <th class="r">Smith XP</th>
          <th>Inputs</th>
          <th class="r">Input Cost</th>
          <th class="r">Bar Sell Price</th>
          <th class="r">Daily Volume</th>
          <th class="r">Furnace Profit</th>
          <th class="r">GP / XP</th>
          <th class="r">Superheat Profit</th>
          <th class="r">GP / XP (SH)</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody id="smelt-body">
        <tr><td colspan="12" style="text-align:center;padding:28px;color:var(--muted)">Fetching prices&hellip;</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- â”€â”€ Anvil tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="tab-anvil" class="tab-panel">
  <div class="controls">
    <div class="ctrl-group">
      <span class="ctrl-label">Metal:</span>
      <button class="cbtn active" onclick="setFilter('all',     this)">All</button>
      <button class="cbtn"        onclick="setFilter('Bronze',  this)">Bronze</button>
      <button class="cbtn"        onclick="setFilter('Iron',    this)">Iron</button>
      <button class="cbtn"        onclick="setFilter('Steel',   this)">Steel</button>
      <button class="cbtn"        onclick="setFilter('Mithril', this)">Mithril</button>
      <button class="cbtn"        onclick="setFilter('Adamant', this)">Adamant</button>
      <button class="cbtn"        onclick="setFilter('Rune',    this)">Rune</button>
    </div>
    <div class="ctrl-group">
      <span class="ctrl-label">Sort:</span>
      <button class="cbtn active" onclick="setSort('level', this)">Level &#9660;</button>
      <button class="cbtn"        onclick="setSort('gpxp',  this)">GP / XP &#9650;</button>
    </div>
  </div>
  <div class="scroll">
    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th>Metal</th>
          <th class="r">Lvl</th>
          <th class="r">Smith XP</th>
          <th class="r">Bars</th>
          <th class="r">Bar Cost</th>
          <th class="r">Sell Price</th>
          <th class="r">Daily Volume</th>
          <th class="r">Profit</th>
          <th class="r">GP / XP</th>
        </tr>
      </thead>
      <tbody id="anvil-body">
        <tr><td colspan="10" style="text-align:center;padding:28px;color:var(--muted)">Fetching prices&hellip;</td></tr>
      </tbody>
    </table>
  </div>
</div>

<footer>
  <strong>Pricing:</strong>
  Inputs use the GE <strong>high (buy) price</strong>; outputs use the <strong>low (sell) price</strong>.
  This reflects worst-case instant-transaction profit.
  <br><br>
  <strong>Superheat Item</strong> (43 Magic) costs 1 Nature rune per cast and also grants <strong>53 Magic XP</strong>
  per cast â€” making it slightly more efficient than the GP/XP column shows for magic training.
  <br><br>
  <strong>Iron bar at furnace</strong> has a 50% success rate â€” the Furnace Profit column is adjusted for lost ore.
  Superheat Item always succeeds.
  <br><br>
  <strong>Anvil tab</strong> uses the buy price of pre-made bars as the input cost.
  Sort by <em>GP / XP</em> to find the cheapest training method at your level.
</footer>

<script>
  // â”€â”€ Smelting data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SI = {
    COPPER_ORE:     { id: 436,  name: 'Copper ore'     },
    TIN_ORE:        { id: 438,  name: 'Tin ore'        },
    IRON_ORE:       { id: 440,  name: 'Iron ore'       },
    SILVER_ORE:     { id: 442,  name: 'Silver ore'     },
    GOLD_ORE:       { id: 444,  name: 'Gold ore'       },
    MITHRIL_ORE:    { id: 447,  name: 'Mithril ore'    },
    ADAMANTITE_ORE: { id: 449,  name: 'Adamantite ore' },
    RUNITE_ORE:     { id: 451,  name: 'Runite ore'     },
    COAL:           { id: 453,  name: 'Coal'           },
    NATURE_RUNE:    { id: 561,  name: 'Nature rune'    },
    BRONZE_BAR:     { id: 2349, name: 'Bronze bar'     },
    IRON_BAR:       { id: 2351, name: 'Iron bar'       },
    STEEL_BAR:      { id: 2353, name: 'Steel bar'      },
    SILVER_BAR:     { id: 2355, name: 'Silver bar'     },
    GOLD_BAR:       { id: 2357, name: 'Gold bar'       },
    MITHRIL_BAR:    { id: 2359, name: 'Mithril bar'    },
    ADAMANTITE_BAR: { id: 2361, name: 'Adamantite bar' },
    RUNITE_BAR:     { id: 2363, name: 'Runite bar'     },
  };

  const SMELT_RECIPES = [
    { name: 'Bronze bar',     level:  1, xp:  6.2, output: SI.BRONZE_BAR,     canSH: true,
      inputs: [{ item: SI.COPPER_ORE, qty: 1 }, { item: SI.TIN_ORE, qty: 1 }] },
    { name: 'Iron bar',       level: 15, xp: 12.5, output: SI.IRON_BAR,       canSH: true, furnaceRate: 0.5,
      inputs: [{ item: SI.IRON_ORE, qty: 1 }],
      note: '50% failure at furnace (profit adjusted). Ring of Forging \u2192 100% for 140 bars.' },
    { name: 'Silver bar',     level: 20, xp: 13.7, output: SI.SILVER_BAR,     canSH: true,
      inputs: [{ item: SI.SILVER_ORE, qty: 1 }] },
    { name: 'Steel bar',      level: 30, xp: 17.5, output: SI.STEEL_BAR,      canSH: true,
      inputs: [{ item: SI.IRON_ORE, qty: 1 }, { item: SI.COAL, qty: 2 }] },
    { name: 'Gold bar',       level: 40, xp: 22.5, output: SI.GOLD_BAR,       canSH: true,
      inputs: [{ item: SI.GOLD_ORE, qty: 1 }],
      note: 'Goldsmith gauntlets (members) raise XP to 56.2/bar.' },
    { name: 'Mithril bar',    level: 50, xp: 30,   output: SI.MITHRIL_BAR,    canSH: true,
      inputs: [{ item: SI.MITHRIL_ORE, qty: 1 }, { item: SI.COAL, qty: 4 }] },
    { name: 'Adamantite bar', level: 70, xp: 37.5, output: SI.ADAMANTITE_BAR, canSH: true,
      inputs: [{ item: SI.ADAMANTITE_ORE, qty: 1 }, { item: SI.COAL, qty: 6 }] },
    { name: 'Runite bar',     level: 85, xp: 50,   output: SI.RUNITE_BAR,     canSH: true,
      inputs: [{ item: SI.RUNITE_ORE, qty: 1 }, { item: SI.COAL, qty: 8 }] },
  ];

  // â”€â”€ Anvil data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // barId: GE id of input bar | outputId: GE id of smithed item
  // outputQty: how many items produced (default 1, e.g. 15 for nails)
  const ANVIL_RECIPES = [
    // â”€â”€ Bronze (12.5 XP / bar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { name: 'Bronze dagger',    metal: 'Bronze',  level:  1, xp:  12.5, bars: 1, barId: 2349, outputId: 1205 },
    { name: 'Bronze axe',       metal: 'Bronze',  level:  1, xp:  12.5, bars: 1, barId: 2349, outputId: 1351 },
    { name: 'Bronze mace',      metal: 'Bronze',  level:  2, xp:  12.5, bars: 1, barId: 2349, outputId: 1422 },
    { name: 'Bronze med helm',  metal: 'Bronze',  level:  3, xp:  12.5, bars: 1, barId: 2349, outputId: 1139 },
    { name: 'Bronze sword',     metal: 'Bronze',  level:  4, xp:  12.5, bars: 1, barId: 2349, outputId: 1277 },
    { name: 'Bronze scimitar',  metal: 'Bronze',  level:  5, xp:  25.0, bars: 2, barId: 2349, outputId: 1321 },
    { name: 'Bronze longsword', metal: 'Bronze',  level:  6, xp:  25.0, bars: 2, barId: 2349, outputId: 1291 },
    { name: 'Bronze full helm', metal: 'Bronze',  level:  7, xp:  25.0, bars: 2, barId: 2349, outputId: 1155 },
    { name: 'Bronze sq shield', metal: 'Bronze',  level:  8, xp:  25.0, bars: 2, barId: 2349, outputId: 1173 },
    { name: 'Bronze warhammer', metal: 'Bronze',  level:  9, xp:  37.5, bars: 3, barId: 2349, outputId: 1337 },
    { name: 'Bronze battleaxe', metal: 'Bronze',  level: 10, xp:  37.5, bars: 3, barId: 2349, outputId: 1375 },
    { name: 'Bronze chainbody', metal: 'Bronze',  level: 11, xp:  37.5, bars: 3, barId: 2349, outputId: 1103 },
    { name: 'Bronze kiteshield',metal: 'Bronze',  level: 12, xp:  37.5, bars: 3, barId: 2349, outputId: 1189 },
    { name: 'Bronze 2h sword',  metal: 'Bronze',  level: 14, xp:  37.5, bars: 3, barId: 2349, outputId: 1307 },
    { name: 'Bronze platelegs', metal: 'Bronze',  level: 16, xp:  37.5, bars: 3, barId: 2349, outputId: 1075 },
    { name: 'Bronze plateskirt',metal: 'Bronze',  level: 16, xp:  37.5, bars: 3, barId: 2349, outputId: 1087 },
    { name: 'Bronze platebody', metal: 'Bronze',  level: 18, xp:  62.5, bars: 5, barId: 2349, outputId: 1117 },
    // â”€â”€ Iron (25 XP / bar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { name: 'Iron dagger',      metal: 'Iron',    level: 15, xp:  25.0, bars: 1, barId: 2351, outputId: 1203 },
    { name: 'Iron axe',         metal: 'Iron',    level: 16, xp:  25.0, bars: 1, barId: 2351, outputId: 1349 },
    { name: 'Iron mace',        metal: 'Iron',    level: 17, xp:  25.0, bars: 1, barId: 2351, outputId: 1420 },
    { name: 'Iron med helm',    metal: 'Iron',    level: 18, xp:  25.0, bars: 1, barId: 2351, outputId: 1137 },
    { name: 'Iron sword',       metal: 'Iron',    level: 19, xp:  25.0, bars: 1, barId: 2351, outputId: 1279 },
    { name: 'Iron scimitar',    metal: 'Iron',    level: 20, xp:  50.0, bars: 2, barId: 2351, outputId: 1323 },
    { name: 'Iron longsword',   metal: 'Iron',    level: 21, xp:  50.0, bars: 2, barId: 2351, outputId: 1293 },
    { name: 'Iron full helm',   metal: 'Iron',    level: 22, xp:  50.0, bars: 2, barId: 2351, outputId: 1153 },
    { name: 'Iron sq shield',   metal: 'Iron',    level: 23, xp:  50.0, bars: 2, barId: 2351, outputId: 1175 },
    { name: 'Iron warhammer',   metal: 'Iron',    level: 24, xp:  75.0, bars: 3, barId: 2351, outputId: 1335 },
    { name: 'Iron battleaxe',   metal: 'Iron',    level: 25, xp:  75.0, bars: 3, barId: 2351, outputId: 1363 },
    { name: 'Iron chainbody',   metal: 'Iron',    level: 26, xp:  75.0, bars: 3, barId: 2351, outputId: 1101 },
    { name: 'Iron kiteshield',  metal: 'Iron',    level: 27, xp:  75.0, bars: 3, barId: 2351, outputId: 1191 },
    { name: 'Iron 2h sword',    metal: 'Iron',    level: 29, xp:  75.0, bars: 3, barId: 2351, outputId: 1309 },
    { name: 'Iron platelegs',   metal: 'Iron',    level: 31, xp:  75.0, bars: 3, barId: 2351, outputId: 1067 },
    { name: 'Iron plateskirt',  metal: 'Iron',    level: 31, xp:  75.0, bars: 3, barId: 2351, outputId: 1081 },
    { name: 'Iron platebody',   metal: 'Iron',    level: 33, xp: 125.0, bars: 5, barId: 2351, outputId: 1115 },
    // â”€â”€ Steel (37.5 XP / bar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { name: 'Steel dagger',     metal: 'Steel',   level: 30, xp:  37.5, bars: 1, barId: 2353, outputId: 1207 },
    { name: 'Steel axe',        metal: 'Steel',   level: 31, xp:  37.5, bars: 1, barId: 2353, outputId: 1353 },
    { name: 'Steel mace',       metal: 'Steel',   level: 32, xp:  37.5, bars: 1, barId: 2353, outputId: 1424 },
    { name: 'Steel med helm',   metal: 'Steel',   level: 33, xp:  37.5, bars: 1, barId: 2353, outputId: 1141 },
    { name: 'Steel sword',      metal: 'Steel',   level: 34, xp:  37.5, bars: 1, barId: 2353, outputId: 1281 },
    { name: 'Steel nails',      metal: 'Steel',   level: 34, xp:  37.5, bars: 1, barId: 2353, outputId: 1539, outputQty: 15 },
    { name: 'Steel scimitar',   metal: 'Steel',   level: 35, xp:  75.0, bars: 2, barId: 2353, outputId: 1325 },
    { name: 'Steel longsword',  metal: 'Steel',   level: 36, xp:  75.0, bars: 2, barId: 2353, outputId: 1295 },
    { name: 'Steel full helm',  metal: 'Steel',   level: 37, xp:  75.0, bars: 2, barId: 2353, outputId: 1157 },
    { name: 'Steel sq shield',  metal: 'Steel',   level: 38, xp:  75.0, bars: 2, barId: 2353, outputId: 1177 },
    { name: 'Steel warhammer',  metal: 'Steel',   level: 39, xp: 112.5, bars: 3, barId: 2353, outputId: 1339 },
    { name: 'Steel battleaxe',  metal: 'Steel',   level: 40, xp: 112.5, bars: 3, barId: 2353, outputId: 1365 },
    { name: 'Steel chainbody',  metal: 'Steel',   level: 41, xp: 112.5, bars: 3, barId: 2353, outputId: 1105 },
    { name: 'Steel kiteshield', metal: 'Steel',   level: 42, xp: 112.5, bars: 3, barId: 2353, outputId: 1193 },
    { name: 'Steel 2h sword',   metal: 'Steel',   level: 44, xp: 112.5, bars: 3, barId: 2353, outputId: 1311 },
    { name: 'Steel platelegs',  metal: 'Steel',   level: 46, xp: 112.5, bars: 3, barId: 2353, outputId: 1069 },
    { name: 'Steel plateskirt', metal: 'Steel',   level: 46, xp: 112.5, bars: 3, barId: 2353, outputId: 1083 },
    { name: 'Steel platebody',  metal: 'Steel',   level: 48, xp: 187.5, bars: 5, barId: 2353, outputId: 1119 },
    // â”€â”€ Mithril (50 XP / bar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { name: 'Mithril dagger',   metal: 'Mithril', level: 50, xp:  50.0, bars: 1, barId: 2359, outputId: 1209 },
    { name: 'Mithril axe',      metal: 'Mithril', level: 51, xp:  50.0, bars: 1, barId: 2359, outputId: 1355 },
    { name: 'Mithril mace',     metal: 'Mithril', level: 52, xp:  50.0, bars: 1, barId: 2359, outputId: 1428 },
    { name: 'Mithril med helm', metal: 'Mithril', level: 53, xp:  50.0, bars: 1, barId: 2359, outputId: 1143 },
    { name: 'Mithril sword',    metal: 'Mithril', level: 54, xp:  50.0, bars: 1, barId: 2359, outputId: 1285 },
    { name: 'Mithril scimitar', metal: 'Mithril', level: 55, xp: 100.0, bars: 2, barId: 2359, outputId: 1329 },
    { name: 'Mithril longsword',metal: 'Mithril', level: 56, xp: 100.0, bars: 2, barId: 2359, outputId: 1299 },
    { name: 'Mithril full helm',metal: 'Mithril', level: 57, xp: 100.0, bars: 2, barId: 2359, outputId: 1159 },
    { name: 'Mithril sq shield',metal: 'Mithril', level: 58, xp: 100.0, bars: 2, barId: 2359, outputId: 1181 },
    { name: 'Mithril warhammer',metal: 'Mithril', level: 59, xp: 150.0, bars: 3, barId: 2359, outputId: 1343 },
    { name: 'Mithril battleaxe',metal: 'Mithril', level: 60, xp: 150.0, bars: 3, barId: 2359, outputId: 1369 },
    { name: 'Mithril chainbody',metal: 'Mithril', level: 61, xp: 150.0, bars: 3, barId: 2359, outputId: 1109 },
    { name: 'Mithril kiteshield',metal:'Mithril', level: 62, xp: 150.0, bars: 3, barId: 2359, outputId: 1197 },
    { name: 'Mithril 2h sword', metal: 'Mithril', level: 64, xp: 150.0, bars: 3, barId: 2359, outputId: 1315 },
    { name: 'Mithril platelegs',metal: 'Mithril', level: 66, xp: 150.0, bars: 3, barId: 2359, outputId: 1071 },
    { name: 'Mithril plateskirt',metal:'Mithril', level: 66, xp: 150.0, bars: 3, barId: 2359, outputId: 1085 },
    { name: 'Mithril platebody',metal: 'Mithril', level: 68, xp: 250.0, bars: 5, barId: 2359, outputId: 1121 },
    // â”€â”€ Adamantite (62.5 XP / bar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { name: 'Adamant dagger',   metal: 'Adamant', level: 70, xp:  62.5, bars: 1, barId: 2361, outputId: 1211 },
    { name: 'Adamant axe',      metal: 'Adamant', level: 71, xp:  62.5, bars: 1, barId: 2361, outputId: 1357 },
    { name: 'Adamant mace',     metal: 'Adamant', level: 72, xp:  62.5, bars: 1, barId: 2361, outputId: 1430 },
    { name: 'Adamant med helm', metal: 'Adamant', level: 73, xp:  62.5, bars: 1, barId: 2361, outputId: 1145 },
    { name: 'Adamant sword',    metal: 'Adamant', level: 74, xp:  62.5, bars: 1, barId: 2361, outputId: 1287 },
    { name: 'Adamant scimitar', metal: 'Adamant', level: 75, xp: 125.0, bars: 2, barId: 2361, outputId: 1331 },
    { name: 'Adamant longsword',metal: 'Adamant', level: 76, xp: 125.0, bars: 2, barId: 2361, outputId: 1301 },
    { name: 'Adamant full helm',metal: 'Adamant', level: 77, xp: 125.0, bars: 2, barId: 2361, outputId: 1161 },
    { name: 'Adamant sq shield',metal: 'Adamant', level: 78, xp: 125.0, bars: 2, barId: 2361, outputId: 1183 },
    { name: 'Adamant warhammer',metal: 'Adamant', level: 79, xp: 187.5, bars: 3, barId: 2361, outputId: 1345 },
    { name: 'Adamant battleaxe',metal: 'Adamant', level: 80, xp: 187.5, bars: 3, barId: 2361, outputId: 1371 },
    { name: 'Adamant chainbody',metal: 'Adamant', level: 81, xp: 187.5, bars: 3, barId: 2361, outputId: 1111 },
    { name: 'Adamant kiteshield',metal:'Adamant', level: 82, xp: 187.5, bars: 3, barId: 2361, outputId: 1199 },
    { name: 'Adamant 2h sword', metal: 'Adamant', level: 84, xp: 187.5, bars: 3, barId: 2361, outputId: 1317 },
    { name: 'Adamant platelegs',metal: 'Adamant', level: 86, xp: 187.5, bars: 3, barId: 2361, outputId: 1073 },
    { name: 'Adamant plateskirt',metal:'Adamant', level: 86, xp: 187.5, bars: 3, barId: 2361, outputId: 1091 },
    { name: 'Adamant platebody',metal: 'Adamant', level: 88, xp: 312.5, bars: 5, barId: 2361, outputId: 1123 },
    // â”€â”€ Runite (75 XP / bar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { name: 'Rune dagger',      metal: 'Rune',    level: 85, xp:  75.0, bars: 1, barId: 2363, outputId: 1213 },
    { name: 'Rune axe',         metal: 'Rune',    level: 86, xp:  75.0, bars: 1, barId: 2363, outputId: 1359 },
    { name: 'Rune mace',        metal: 'Rune',    level: 87, xp:  75.0, bars: 1, barId: 2363, outputId: 1432 },
    { name: 'Rune med helm',    metal: 'Rune',    level: 88, xp:  75.0, bars: 1, barId: 2363, outputId: 1147 },
    { name: 'Rune sword',       metal: 'Rune',    level: 89, xp:  75.0, bars: 1, barId: 2363, outputId: 1289 },
    { name: 'Rune scimitar',    metal: 'Rune',    level: 90, xp: 150.0, bars: 2, barId: 2363, outputId: 1333 },
    { name: 'Rune longsword',   metal: 'Rune',    level: 91, xp: 150.0, bars: 2, barId: 2363, outputId: 1303 },
    { name: 'Rune full helm',   metal: 'Rune',    level: 92, xp: 150.0, bars: 2, barId: 2363, outputId: 1163 },
    { name: 'Rune sq shield',   metal: 'Rune',    level: 93, xp: 150.0, bars: 2, barId: 2363, outputId: 1185 },
    { name: 'Rune warhammer',   metal: 'Rune',    level: 94, xp: 225.0, bars: 3, barId: 2363, outputId: 1347 },
    { name: 'Rune battleaxe',   metal: 'Rune',    level: 95, xp: 225.0, bars: 3, barId: 2363, outputId: 1373 },
    { name: 'Rune chainbody',   metal: 'Rune',    level: 96, xp: 225.0, bars: 3, barId: 2363, outputId: 1113 },
    { name: 'Rune kiteshield',  metal: 'Rune',    level: 97, xp: 225.0, bars: 3, barId: 2363, outputId: 1201 },
    { name: 'Rune 2h sword',    metal: 'Rune',    level: 99, xp: 225.0, bars: 3, barId: 2363, outputId: 1319 },
    { name: 'Rune platelegs',   metal: 'Rune',    level: 99, xp: 225.0, bars: 3, barId: 2363, outputId: 1079 },
    { name: 'Rune plateskirt',  metal: 'Rune',    level: 99, xp: 225.0, bars: 3, barId: 2363, outputId: 1093 },
    { name: 'Rune platebody',   metal: 'Rune',    level: 99, xp: 375.0, bars: 5, barId: 2363, outputId: 1127 },
  ];

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let prices      = {};
  let volumes     = {};  // { [id]: daily_volume }
  let anvilSort   = 'level';  // 'level' | 'gpxp'
  let anvilFilter = 'all';    // 'all' | metal name

  // â”€â”€ Price lookups â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const buyPrice  = id => prices[id]?.high ?? null;
  const sellPrice = id => prices[id]?.low  ?? null;

  // â”€â”€ Formatting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function fmtVol(n) {
    if (n == null) return '\u2014';
    if (n >= 1e6)  return (n / 1e6).toFixed(1) + 'M';
    if (n >= 1e3)  return Math.round(n / 1e3) + 'k';
    return n.toLocaleString();
  }

  // Volume cell: green >= 100k/day, muted >= 10k, red below
  function volCell(id) {
    const v = volumes[id];
    if (v == null) return `<span class="na">\u2014</span>`;
    const cls = v >= 100_000 ? 'vol-hi' : v >= 10_000 ? 'vol-mid' : 'vol-lo';
    return `<span class="${cls}">${fmtVol(v)}</span>`;
  }

  function fmtGP(n, sign = false) {
    if (n == null) return '\u2014';
    const abs = Math.abs(n);
    const s   = sign ? (n > 0 ? '+' : n < 0 ? '-' : '') : (n < 0 ? '-' : '');
    if (abs >= 1e6) return s + (abs / 1e6).toFixed(2) + 'M';
    if (abs >= 1e3) return s + (abs / 1e3).toFixed(1) + 'k';
    return s + abs.toLocaleString();
  }

  // â”€â”€ Shared cell renderers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function profitCell(val) {
    if (val == null) return `<span class="na">\u2014</span>`;
    const cls   = val > 0 ? 'pos' : 'neg';
    const badge = val > 0
      ? `<span class="badge bp">PROFIT</span>`
      : `<span class="badge bl">LOSS</span>`;
    return `<span class="${cls}">${fmtGP(val, true)}</span>${badge}`;
  }

  function gpxpCell(profit, xp) {
    if (profit == null) return `<span class="na">\u2014</span>`;
    if (profit >= 0)    return `<span class="pos">Paid to train</span>`;
    return `<span class="neg">${(-profit / xp).toFixed(1)} gp/xp</span>`;
  }

  // â”€â”€ Smelting rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderSmelt() {
    const nrp = buyPrice(SI.NATURE_RUNE.id);

    const html = SMELT_RECIPES.map(r => {
      let cost = 0;
      for (const { item, qty } of r.inputs) {
        const p = buyPrice(item.id);
        if (p == null) { cost = null; break; }
        cost += p * qty;
      }
      const sell  = sellPrice(r.output.id);
      const rate  = r.furnaceRate ?? 1;
      const furnP = (cost != null && sell != null) ? sell - cost / rate : null;
      const shP   = (cost != null && sell != null && nrp != null) ? sell - cost - nrp : null;

      const inputsHtml = r.inputs.map(({ item, qty }) => {
        const p = buyPrice(item.id);
        const ea = p != null ? ` <span class="each">(${fmtGP(p)} ea)</span>` : '';
        return `<span class="qty">${qty}&times;</span>${item.name}${ea}`;
      }).join('<br>');

      const failNote = r.furnaceRate
        ? `<div class="sub-note">adjusted for ${r.furnaceRate * 100}% success</div>` : '';
      const shCell = r.canSH ? profitCell(shP)    : `<span class="na">N/A</span>`;
      const sxCell = r.canSH ? gpxpCell(shP, r.xp): `<span class="na">N/A</span>`;

      return `<tr>
        <td><strong>${r.name}</strong></td>
        <td class="r" style="color:var(--muted)">${r.level}</td>
        <td class="r" style="color:var(--muted)">${r.xp}</td>
        <td class="inputs">${inputsHtml}</td>
        <td class="r">${fmtGP(cost)}</td>
        <td class="r">${fmtGP(sell)}</td>
        <td class="r">${volCell(r.output.id)}</td>
        <td class="r">${profitCell(furnP)}${failNote}</td>
        <td class="r">${gpxpCell(furnP, r.xp)}</td>
        <td class="r">${shCell}</td>
        <td class="r">${sxCell}</td>
        <td class="note-cell">${r.note ?? ''}</td>
      </tr>`;
    }).join('');

    document.getElementById('smelt-body').innerHTML = html;
  }

  // â”€â”€ Anvil rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderAnvil() {
    let rows = ANVIL_RECIPES
      .filter(r => anvilFilter === 'all' || r.metal === anvilFilter)
      .map(r => {
        const barCost  = buyPrice(r.barId);
        const itemSell = sellPrice(r.outputId);
        const outQty   = r.outputQty ?? 1;
        const cost     = barCost  != null ? barCost * r.bars : null;
        const sell     = itemSell != null ? itemSell * outQty : null;
        const profit   = (cost != null && sell != null) ? sell - cost : null;
        return { ...r, cost, sell, profit };
      });

    if (anvilSort === 'gpxp') {
      // Sort: best profit per XP first (most profitable â†’ least costly training)
      rows.sort((a, b) => {
        const ka = a.profit != null ? a.profit / a.xp : -Infinity;
        const kb = b.profit != null ? b.profit / b.xp : -Infinity;
        return kb - ka;
      });
    } else {
      rows.sort((a, b) => a.level - b.level || a.xp - b.xp);
    }

    const html = rows.map(r => {
      const noteHtml = r.outputQty ? `<span style="font-size:0.76rem;color:var(--muted)">&times;${r.outputQty} output</span>` : '';
      return `<tr>
        <td><strong>${r.name}</strong> ${noteHtml}</td>
        <td><span class="pill pill-${r.metal}">${r.metal}</span></td>
        <td class="r" style="color:var(--muted)">${r.level}</td>
        <td class="r" style="color:var(--muted)">${r.xp}</td>
        <td class="r" style="color:var(--muted)">${r.bars}</td>
        <td class="r">${fmtGP(r.cost)}</td>
        <td class="r">${fmtGP(r.sell)}</td>
        <td class="r">${volCell(r.outputId)}</td>
        <td class="r">${profitCell(r.profit)}</td>
        <td class="r">${gpxpCell(r.profit, r.xp)}</td>
      </tr>`;
    }).join('');

    document.getElementById('anvil-body').innerHTML =
      html || `<tr><td colspan="9" style="text-align:center;padding:20px;color:var(--muted)">No items.</td></tr>`;
  }

  // â”€â”€ Main render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function render() {
    renderSmelt();
    renderAnvil();

    const nrp = buyPrice(SI.NATURE_RUNE.id);
    document.getElementById('nature-price').textContent =
      nrp != null ? `Nature rune: ${fmtGP(nrp)} gp` : '';
  }

  // â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showTab(name, btn) {
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');
    btn.classList.add('active');
  }

  // â”€â”€ Anvil controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setFilter(metal, btn) {
    anvilFilter = metal;
    document.querySelectorAll('.cbtn[onclick^="setFilter"]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderAnvil();
  }

  function setSort(sort, btn) {
    anvilSort = sort;
    document.querySelectorAll('.cbtn[onclick^="setSort"]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderAnvil();
  }

  // â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const API_LATEST  = 'https://prices.runescape.wiki/api/v1/osrs/latest';
  const API_VOLUMES = 'https://prices.runescape.wiki/api/v1/osrs/volumes';

  async function fetchPrices() {
    const st = document.getElementById('status');
    st.className = 'loading';
    st.textContent = 'Fetching prices\u2026';
    try {
      const [priceRes, volRes] = await Promise.all([
        fetch(API_LATEST),
        fetch(API_VOLUMES),
      ]);
      if (!priceRes.ok) throw new Error(`HTTP ${priceRes.status}`);
      if (!volRes.ok)   throw new Error(`HTTP ${volRes.status}`);

      const [priceJson, volJson] = await Promise.all([priceRes.json(), volRes.json()]);

      prices = {};
      for (const [k, v] of Object.entries(priceJson.data)) prices[+k] = v;

      volumes = {};
      for (const [k, v] of Object.entries(volJson.data)) volumes[+k] = v;

      render();
      st.className = '';
      st.textContent = `Updated ${new Date().toLocaleTimeString()}`;
      secondsLeft = 60;
    } catch (e) {
      st.className = 'error';
      st.textContent = `Error: ${e.message}`;
      console.error(e);
    }
  }

  // â”€â”€ Countdown / auto-refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let secondsLeft = 60;

  setInterval(() => {
    secondsLeft--;
    document.getElementById('countdown').textContent = `Next refresh in ${secondsLeft}s`;
    if (secondsLeft <= 0) { secondsLeft = 60; fetchPrices(); }
  }, 1000);

  function refresh() { secondsLeft = 60; fetchPrices(); }

  fetchPrices();
</script>
</body>
</html>
